<html>
<head>
	<title>Tasks</title>
	<link rel="stylesheet" href="../fan.css" type="text/css">
	<link rel="stylesheet" href="Tasks.css" type="text/css">
</head>
<body>
	<script type="text/javascript" src="../lib/raphael/raphael.js"></script>
	<script type="text/javascript" src="../lib/g.raphael/g.raphael.js"></script>
	<script type="text/javascript" src="../lib/g.raphael/g.line.js"></script>
<script type="text/javascript" src="../lib/fin/lib/js.io/packages/jsio.js"></script>
<script>
	jsio.path.client = '../lib/fin/js'
	jsio.path.shared = '../lib/fin/js'
	jsio.path.fan = '../'
	
	Meebo=function(){(Meebo._=Meebo._||[]).push(arguments)};
	Meebo('domReady')
	
	jsio('import client.fin') // makes fin globally accesible
	
	window.gBody = document.body
	window.gUserId = null
	
	jsio('import fan.views.Value')
	jsio('import fan.views.Input')
	jsio('import fan.views.Checkbox')
	jsio('import fan.views.ListView')
	jsio('import fan.views.Editable')
	jsio('import fan.views.SortedItemListView')
	jsio('import fan.views.ItemSetSelect')
	jsio('import fan.views.BurndownChart')
	jsio('import fan.views.Comments')
	
	fin.registerView('Value', fan.views.Value)
	fin.registerView('Number', fan.views.Value) // TODO Create number view that only accepts number input
	fin.registerView('Input', fan.views.Input)
	fin.registerView('Checkbox', fan.views.Checkbox)
	fin.registerView('ListView', fan.views.ListView)
	fin.registerView('Editable', fan.views.Editable)
	fin.registerView('SortedItemListView', fan.views.SortedItemListView)
	fin.registerView('ItemSetSelect', fan.views.ItemSetSelect)
	fin.registerView('BurndownChart', fan.views.BurndownChart)
	fin.registerView('Comments', fan.views.Comments)
	
	jsio('import fan.tasks.LoginManager')
	jsio('import fan.tasks.panels.LabelsPanel')
	jsio('import fan.tasks.panels.ListPanel')
	jsio('import fan.tasks.panels.ItemPanel')
	jsio('import fan.ui.overlay')
	
	jsio('import client.xhr')
	
	gUtil = {
		_templates: {},
		_templateQueue: {},
		loadTemplate: function(itemType, viewType, callback) {
			var path = 'templates/' + itemType + '/' + viewType + '.html'
			if (gUtil._templates[path]) { 
				callback(gUtil._templates[path])
			} else if (gUtil._templateQueue[path]) {
				gUtil._templateQueue[path].push(callback)
			} else {
				gUtil._templateQueue[path] = [callback]
				client.xhr.get(path, function(template) {
					gUtil._templates[path] = template
					var cbs = gUtil._templateQueue[path]
					for (var i=0, cb; cb = cbs[i]; i++) {
						cb(template)
					}
				})
			}
		}
	}
	
	window.gLoginManager = new fan.tasks.LoginManager()

	fin.registerEventHandler('FAN_AUTHENTICATION_DEMAND', function() {
		fan.ui.overlay.show(gLoginManager.getElement())
		gLoginManager.focus()
	})

	fin.registerEventHandler('FAN_AUTHENTICATION_RESPONSE', function(response) {
		if (response.authenticated) {
			gUserId = response.id
			openApp()
		} else {
			alert("That didn't work.\n\n" + response.reason)
		}
	})
	
	gLoginManager.subscribe('Login', function(email, passwordHash){
		fin.send('FAN_AUTHENTICATION_REQUEST', { email: email, password_hash: passwordHash })
	})
	
	gLoginManager.subscribe('Create', function(email, passwordHash){
		fin.send('FAN_REQUEST_CREATE_USER', { email: email, password_hash: passwordHash })
	})
	
	
	
	
	fin.connect(function(){
		window.gLabelsPanel = new fan.tasks.panels.LabelsPanel()
		window.gListPanel = new fan.tasks.panels.ListPanel()
		window.gItemPanel = new fan.tasks.panels.ItemPanel()
	})
	
	function openApp() {
		fan.ui.overlay.remove()

		if (openApp.initialized) { return }
		openApp.initialized = true
		
		// global sets
		// window.gProjects = []
		// window.gUsers = []
		// fin.query({ 'type': 'user' })
		// fin.query({ 'type': 'project' })
		
		gLabelsPanel.appendTo(gBody)
		gListPanel.appendTo(gBody)
		gItemPanel.appendTo(gBody)
		
		;(function initMeebo(q) {
			return
			var d=document,b=d.body,m=b.insertBefore(d.createElement('div'),b.firstChild),s=d.createElement('script');
			m.id='meebo';m.style.display='none';m.innerHTML='<iframe id="meebo-iframe"></iframe>';
			s.src='http'+(q.https?'s':'')+'://'+(q.stage?'stage-':'')+'cim.meebo.com/cim/cim.php?network='+q.network;
			b.insertBefore(s,b.firstChild);
		})({ network:'everywhere',stage:false })
		
		var items = [{ value: 'task', label: 'Create new Task' }, { value: 'project', label: 'Create new Project'}]
		Meebo('addButton', { type: 'menu', label: 'Create new ...', items: items, onSelect: function(value) {
			fin.create({ type: value }, function(item) {
				gItemPanel.setItem(item)
			})
		}})
	}
	
</script>

<body>
</body>
</html>
